generator client {
  provider = "prisma-client-js"
}

/**
 * Prisma Schema Notes
 * -------------------
 * - Enum values for Postgres-backed enums must be added carefully: Postgres
 * requires enum value additions to be committed before they are referenced
 * in subsequent migrations. When adding new enum labels (e.g., UNTESTED),
 * create a migration that performs only the ALTER TYPE ... ADD VALUE
 * statement and apply it before creating rows that use the new label.
 * - Keep this note near the top of the schema to remind contributors about
 * safe enum migration practices.
 */

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  OWNER
  CONTRIBUTOR
}

enum TestCaseType {
  MANUAL
  AUTOMATION
}

enum TestResultStatus {
  UNTESTED
  PASSED
  FAILED
  BLOCKED
}

enum BugStatus {
  OPEN
  CLOSED
}

enum BugSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum BugPriority {
  P0
  P1
  P2
  P3
}

enum AutomationStatus {
  AUTOMATED
  FLAKY
  NOT_AUTOMATED
}

enum TestRunExecutionStatus {
  STARTED
  IN_PROGRESS
  COMPLETED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // üîê NextAuth relations (REQUIRED)
  accounts Account[]
  sessions Session[]

  // Relations
  ownedProjects    Project[]       @relation("ProjectOwner")
  projectMembers   ProjectMember[]
  testRuns         TestRun[]       @relation("UserTestRuns")
  aiUsage          AIUsage[]
  assignedTestRuns TestRun[]       @relation("AssignedRuns")
  assignedTasks    Task[]          @relation("AssignedTasks")
  createdTasks     Task[]          @relation("CreatedTasks")
  taskComments     TaskComment[]   @relation("TaskCommentAuthor")

  createdBugs        Bug[]        @relation("BugCreator")
  createdInvitations Invitation[] @relation("InvitationCreator")

  @@map("users")
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  owner       User                 @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members     ProjectMember[]
  modules     Module[]
  testCases   TestCase[]
  testRuns    TestRun[]
  behaviors   ProjectBehavior[]
  productSpec ProductSpec?
  uiRefs      ProjectUIReference[]
  tasks       Task[]

  bugs        Bug[]
  invitations Invitation[]

  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(cuid())
  userId    String
  projectId String
  role      Role     @default(CONTRIBUTOR)
  joinedAt  DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@map("project_members")
}

model Module {
  id          String   @id @default(cuid())
  name        String
  description String?
  projectId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project   Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testCases TestCase[]
  behaviors ProjectBehavior[]
  productSpec ModuleSpec?
  uiRefs      ModuleUIReference[]

  @@map("modules")
}

model TestCase {
  id            String         @id @default(cuid())
  title         String
  description   String?
  steps         Json
  expected      String
  tags          String[]
  type          TestCaseType   @default(MANUAL)
  automationRef AutomationRef?
  projectId     String
  moduleId      String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  project Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  module  Module?      @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  results TestResult[]
  bugs    Bug[]

  @@map("test_cases")
}

model TestRun {
  id           String                 @id @default(cuid())
  name         String
  projectId    String
  userId       String
  assignedToId String?
  setup        Json?
  startedAt    DateTime               @default(now())
  endedAt      DateTime?
  status       TestRunExecutionStatus @default(STARTED)
  isLocked     Boolean                @default(false)

  // Relations
  project    Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User         @relation("UserTestRuns", fields: [userId], references: [id], onDelete: Cascade)
  assignedTo User?        @relation("AssignedRuns", fields: [assignedToId], references: [id])
  results    TestResult[]
  bugs       Bug[]

  @@map("test_runs")
}

model TestResult {
  id         String           @id @default(cuid())
  status     TestResultStatus @default(UNTESTED)
  notes      String?
  testCaseId String
  testRunId  String
  createdAt  DateTime         @default(now())

  // Relations
  testCase TestCase @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
  testRun  TestRun  @relation(fields: [testRunId], references: [id], onDelete: Cascade)

  @@unique([testCaseId, testRunId])
  @@map("test_results")
}

model Bug {
  id          String       @id @default(cuid())
  title       String
  description String?
  status      BugStatus    @default(OPEN)
  severity    BugSeverity?
  priority    BugPriority?
  testCaseId  String?
  testRunId   String?
  projectId   String
  creatorId   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  testCase TestCase? @relation(fields: [testCaseId], references: [id], onDelete: SetNull)
  testRun  TestRun?  @relation(fields: [testRunId], references: [id], onDelete: SetNull)
  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator  User      @relation("BugCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  @@map("bugs")
}

model Invitation {
  id        String   @id @default(cuid())
  email     String
  role      Role     @default(CONTRIBUTOR)
  projectId String
  creatorId String
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator User    @relation("InvitationCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([email, projectId])
  @@map("invitations")
}

model AutomationRef {
  id         String           @id @default(cuid())
  testCaseId String           @unique
  repoUrl    String
  filePath   String
  testName   String
  status     AutomationStatus @default(NOT_AUTOMATED)
  createdAt  DateTime         @default(now())

  testCase TestCase @relation(fields: [testCaseId], references: [id], onDelete: Cascade)

  @@map("automation_refs")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model AIUsage {
  id        String   @id @default(cuid())
  userId    String
  action    String // "improve" | "generate" | "analyze"
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, action, createdAt])
}

enum BehaviorScope {
  PROJECT
  MODULE
}

model ProjectBehavior {
  id String @id @default(cuid())

  projectId String
  moduleId  String? // null when GLOBAL

  scope        BehaviorScope
  userAction   String
  systemResult String
  createdAt    DateTime      @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  module Module? @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([moduleId])
}

model ProductSpec {
  id        String @id @default(cuid())
  projectId String @unique

  content Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("product_specs")
}

model ModuleSpec {
  id       String @id @default(cuid())
  moduleId String @unique

  content Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  module Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@map("module_specs")
}

enum UIReferenceSource {
  FIGMA
  SCREENSHOT
  OTHER
}

model ProjectUIReference {
  id        String @id @default(cuid())
  projectId String

  title       String
  imageUrl    String
  source      UIReferenceSource @default(SCREENSHOT)
  description String?

  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("project_ui_references")
}

model ModuleUIReference {
  id       String @id @default(cuid())
  moduleId String

  title       String
  imageUrl    String
  source      UIReferenceSource @default(SCREENSHOT)
  description String?

  createdAt DateTime @default(now())

  module Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
  @@map("module_ui_references")
}

model Task {
  id        String @id @default(cuid())
  projectId String

  title       String
  description String?

  status TaskStatus @default(TODO)

  assignedToId String?
  createdById  String

  dueDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project    Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedTo User?         @relation("AssignedTasks", fields: [assignedToId], references: [id])
  createdBy  User          @relation("CreatedTasks", fields: [createdById], references: [id])
  comment    TaskComment[]

  @@index([projectId])
  @@index([assignedToId])
  @@map("tasks")
}

model TaskComment {
  id       String @id @default(cuid())
  taskId   String
  authorId String

  content   String
  createdAt DateTime @default(now())

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  author User @relation("TaskCommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([authorId])
  @@map("task_comments")
}
